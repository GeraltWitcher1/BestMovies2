@page "/{userEmail}/movies"

@using BestMovies.WebApp.Repositories
@using BestMovies.WebApp.Services
@using BestMovies.Shared.Dtos.Movies
@using BestMovies.Shared.Validators
@using BestMovies.WebApp.Authorization
@using BestMovies.WebApp.Components
@using EventHandler = BestMovies.WebApp.Services.EventHandler

<PageTitle>Watch list</PageTitle>

<MudContainer Class="d-flex flex-column gap-4 justify-center pa-4" MaxWidth="MaxWidth.ExtraExtraLarge">
    <MovieCardList Title="Want To Watch" Movies="_wantToWatchMovies" SkeletonCardsCount="5"/>
</MudContainer>

<MudContainer Class="d-flex flex-column gap-4 justify-center pa-4" MaxWidth="MaxWidth.ExtraExtraLarge">
    <MovieCardList Title="Watched" Movies="_watchedMovies" SkeletonCardsCount="5"/>
</MudContainer>


@code {
    [Inject]
    protected EventHandler EventHandler { get; set; } = default!;

    [Inject]
    protected ISavedMoviesRepository SavedMoviesRepository { get; set; } = default!;

    [Inject]
    protected IAuthService AuthService { get; set; } = default!;

    [Parameter]
    public string UserEmail { get; set; } = default!;

    private IEnumerable<SearchMovieDto>? _watchedMovies;
    private IEnumerable<SearchMovieDto>? _wantToWatchMovies;

    private UserInformation? _userInformation;
    private readonly EmailValidator _emailValidator = new();

    protected override async Task OnInitializedAsync()
    {
        EventHandler.OnChange += OnChange;

        if (!await ValidateUserEmail()) return;
        
        var tasks = new[]
        {
            FetchWatchedMovies(),
            FetchWantToWatchMovies(),
            FetchUserInfo()
        };

        await Task.WhenAll(tasks);
        StateHasChanged();
    }
    
    private async Task FetchUserInfo() => _userInformation = await AuthService.RetrieveUserInformation();
    private async Task FetchWatchedMovies() => _watchedMovies = await SavedMoviesRepository.GetSavedMoviesForUser(UserEmail ,isWatched: true);
    private async Task FetchWantToWatchMovies() => _wantToWatchMovies = await SavedMoviesRepository.GetSavedMoviesForUser(UserEmail, isWatched: false);

    private async Task<bool> ValidateUserEmail()
    {
        var result = await _emailValidator.ValidateAsync(UserEmail);
        if (!result.IsValid)
        {
            Console.WriteLine("Invalid email");
        }

        return result.IsValid;
    }
    
    private async void OnChange()
    {
        var tasks = new[]
        {
            FetchWatchedMovies(),
            FetchWantToWatchMovies()
        };

        await Task.WhenAll(tasks);
        StateHasChanged();
    }
}